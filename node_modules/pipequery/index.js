const es = require('event-stream')
const exec = function(json, code) {
  if (/^\./.test(code)) {
    const fn = eval(`function fun() { return ${code === '.' ? 'this' : 'this' + code} }; fun;`)
    return fn.call(json)
  } else {
    const fn = eval(`function fun() { return ${code} }; fun;`)
    const f = fn.call(json)
    if (typeof f === 'function') {
      return f(json)
    } else {
      return f
    }
  }
}
const run = function(json, codes) {
  if (!Array.isArray(codes)) { codes = [codes] }
  codes.forEach(function(code) {
    json = exec(json, code)
  })
  return json;
}
const pipe = function(instream, codes) {
  return instream.pipe(es.map(function(data, cb) {
    let result = run(data, codes)
    cb(null, result)
  }))
}
module.exports = {
  run: run,
  pipe: pipe
}
